# Spring boot
---
## 스프링 DB 접근 기술
---
스프링 데이터 엑세스

### H2 데이터 베이스 설치
```
개발이나 테스트 용도로 가볍고 편리한 DB, 웹하면 제공
```
- [https://www.h2database.com]   
- 다운로드 및 설치   
- h2 데이터베이스 버전은 스프링 부트 버전에 맞춘다   
- 권한 주기 : `chmod 755 h2.sh`   
- 실행 : `./h2.sh`   
- 데이터베이스 파일 생성 방법   
        ● `jdbc:h2:~/test`(최초한번)   
        ● `~/test.mv.db`파일 생성확인       
        ● 이후부터는 `jdbc:h2:tcp://localhost/~/test` 이렇게 접속   

**테이블 생성하기**

테이블 관리를 위해 프로젝트 루트에`sql/ddl.sql` 파일을 생성
``` sql
drop table if exists member CASCADE;
create table member
(
        id bigint generated by default as identity,
        name varchar(255),
        primary key (id)
);
```
H2 데이터베이스에 접근해서 `member`테이블 생성

> H2 데이터베이스가 정상 생성되지 않을 때   
다음과 같은 오류 메시지가 나오며 H2 데이터베이스가 정상 생성도지 않는 경우가 있다.
![](https://cdn.inflearn.com/public/files/posts/5497ed36-6614-4e17-8a96-2bd2ab49899e/%EC%9D%B8%ED%94%84%EB%9F%B0%20h2%20%EC%A7%88%EB%AC%B8.PNG)
>> 해결방안   
>> 1. H2 데이터베이스를 종료하고, 다시 시작한다.      
>> 2. 웹 브라우저가 자동 실행되면 주소창에 다음과 같이 되어있다.(192.168.0.24가 아니라 임의의 숫자가 나온다.)   
![](https://velog.velcdn.com/images/heyhighbyee/post/1ec233a7-6cc4-41c6-beb5-a72a9c51c924/image.png)   
>> 3. 다음과 같이 앞부분만 `192.168.0.24`→`localhost`로 변경하고 Enter를 입력한다. 나머지 부분은 절대 변경하면 안된다.(특히 뒤에 세션 부분이 변경되면 안된다.)   
![](https://velog.velcdn.com/images%2Fdbal9357%2Fpost%2F0cbb725d-ec97-442d-9389-3c97a6477361%2F%EB%B0%B0%EC%B9%98%ED%8C%8C%EC%9D%BC2.png)   
>> 4. 데이터베이스 파일을 생성하면`(jdbc:h2:~/test)`, 데이터베이스가 정상 생성된다.   
---
### 순수 JDBC 
#### 환경 설정   
**build.gradle 파일에 jdbc, h2 데이터베이스 관련 라이브러리 추가**   
``` java
implementation 'org.springframework.boot:spring-boot-starter-jdbc'
runtimeOnly 'com.h2database:h2'
```
application.properties에 추가
``` java
spring.datasource.url=jdbc:h2:tcp://localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
spring.datasource.username=sa
```

스프링 부트 데이터베이스 연결 설정 추가   
`resources/application.properties`
``` java
spring.datasource.url=jdbc:h2:tcp: //localhost/~/test
spring.datasource.driver-class-name=org.h2.Driver
```
Jdbc 리포지토리 구현   

구현 클래스 추가 이미지   
![](https://user-images.githubusercontent.com/67407678/110061765-78882500-7dab-11eb-8640-67369eb579bc.PNG)   

스프링 설정 이미지         
![](https://blog.kakaocdn.net/dn/rrceF/btqF3GVIhtQ/JA9JAZ9MH3ZAolR9PM2gS1/img.png)   

- 개방 폐쇠 원칙(OCP, Open-Closed Principle)   
        - 확장에는 열려있고, 수정에는 닫혀있다.
- 스프링의 DI(Dependncies Injection)을 사용하면 **기존 코드를 전혀 손대지 않고, 설정만으로 구현 클래스를 변경**할 수 있다.   
- 데이터를 DB에 저장하므로 스프링 서버를 다시 실행해도 데이터가 안전하게 저장된다. 
---
### 스프링 통합 테스트
스프링 컨테이너와 DB까지 연결한 통합 테스트를 진행   

**회원 서비스 스프링 통합 테스트**   
``` java
package hello.hellosping.service;

import hello.hellosping.domain.Member;
import hello.hellosping.repository.MemberRepository;
import hello.hellosping.repository.MemoryMemberRepository;
import org.assertj.core.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.transaction.annotation.Transactional;

import static org.junit.jupiter.api.Assertions.assertThrows;

@SpringBootTest
@Transactional
class MemberServiceIntegrationTest {

    @Autowired MemberService memberService;
    @Autowired MemberRepository memberRepository;

    @Test
    void join() throws Exception {
        // given
        Member member = new Member();
        member.setName("hello");

        // when
        Long saveId = memberService.join(member);

        // then
        Member findMember = memberService.findOne(saveId).get();
        Assertions.assertThat(member.getName()).isEqualTo(findMember.getName());
    }

    @Test
    public void 중복_회원_예외() throws Exception {
        // given
        Member member1 = new Member();
        member1.setName("spring");

        Member member2 = new Member();
        member2.setName("spring");

        // when
        memberService.join(member1);
        IllegalStateException e = assertThrows(IllegalStateException.class, () -> memberService.join(member2));

        assertThat(e.getMessage()).isEqualTo("이미 존재하는 회원입니다.");
    }
}
```
- `@SpringBootTest` : 스프링 컨테이너와 테스트를 함께 실행한다.   
- `@Transactional` : 테스트 케이스에 이 애노테이션이 있으면, 테스트 시작 전에 트랜잭션을 시작하고, 테스트 완료 후에 항상 롤백한다. 이렇게 하면 DB에 데이터가 남지 않으므로 다음 테스트에 영향을 주지 않는다   